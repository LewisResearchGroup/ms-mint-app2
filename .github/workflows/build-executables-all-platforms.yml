name: Build Executables (Optimized)

on:
  push:
    tags:
      - 'v*'  # Only build on version tags to save resources
  workflow_dispatch:  # Allow manual triggering

jobs:
  build-windows:
    name: Build Windows Executable
    runs-on: windows-latest
    timeout-minutes: 180
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Free up disk space
        run: |
          # Remove unnecessary software to free up space
          Remove-Item -Recurse -Force "C:\hostedtoolcache\windows\Python\3.7" -ErrorAction SilentlyContinue
          Remove-Item -Recurse -Force "C:\hostedtoolcache\windows\Python\3.8" -ErrorAction SilentlyContinue
          Remove-Item -Recurse -Force "C:\hostedtoolcache\windows\Python\3.9" -ErrorAction SilentlyContinue
          Remove-Item -Recurse -Force "C:\hostedtoolcache\windows\Python\3.10" -ErrorAction SilentlyContinue
          Remove-Item -Recurse -Force "C:\hostedtoolcache\windows\Python\3.11" -ErrorAction SilentlyContinue
        shell: powershell
        continue-on-error: true

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
          cache: 'pip'
          cache-dependency-path: |
            pyproject.toml
            requirements-dev.txt

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip wheel setuptools
          pip install pyinstaller
          pip install "matplotlib>=3.10.8"
          pip install -e . --no-cache-dir
        shell: bash

      - name: Create Asari environment
        run: |
          cd pyinstaller
          python create_asari_env.py
        shell: bash

      - name: Generate matplotlib font cache
        run: |
          cd pyinstaller
          python prebuild_matplotlib_cache.py
        shell: bash

      - name: Build executable with PyInstaller
        run: |
          cd pyinstaller
          pyinstaller --noconfirm --clean --log-level=INFO Mint.spec
        shell: bash
        env:
          PYTHONOPTIMIZE: 1

      - name: Verify build and check size
        run: |
          if (Test-Path "pyinstaller\dist\Mint\Mint.exe") {
            Write-Host "‚úì Executable built successfully!"
            
            $size = (Get-ChildItem -Path "pyinstaller\dist\Mint" -Recurse | Measure-Object -Property Length -Sum).Sum
            Write-Host "Build size: $([math]::Round($size/1GB, 2)) GB"
          } else {
            Write-Host "‚úó Build failed"
            exit 1
          }
        shell: powershell

      - name: Create archive with maximum compression
        run: |
          cd pyinstaller/dist
          Compress-Archive -Path Mint -DestinationPath Mint-Windows-x64.zip -CompressionLevel Optimal
          
          $zipSize = (Get-Item Mint-Windows-x64.zip).Length
          Write-Host "Archive size: $([math]::Round($zipSize/1MB, 2)) MB"
        shell: powershell

      - name: Get version
        id: get_version
        run: |
          if [[ "$GITHUB_REF" == refs/tags/* ]]; then
            version=${GITHUB_REF#refs/tags/}
            if [[ "$version" =~ (alpha|beta|rc|preview) ]]; then
              is_prerelease=true
            else
              is_prerelease=false
            fi
          else
            version="dev-$(git rev-parse --short HEAD)"
            is_prerelease=true
          fi
          echo "version=$version" >> $GITHUB_OUTPUT
          echo "is_prerelease=$is_prerelease" >> $GITHUB_OUTPUT
        shell: bash

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: Mint-Windows-x64-${{ steps.get_version.outputs.version }}
          path: pyinstaller/dist/Mint-Windows-x64.zip
          retention-days: 90
          compression-level: 0  # Already compressed

  build-linux:
    name: Build Linux Executable
    runs-on: ubuntu-latest
    timeout-minutes: 180
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Free up disk space
        run: |
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /usr/local/lib/android
          sudo rm -rf /opt/ghc
          sudo rm -rf /opt/hostedtoolcache/CodeQL
          sudo docker image prune --all --force
          df -h
        continue-on-error: true

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
          cache: 'pip'
          cache-dependency-path: |
            pyproject.toml
            requirements-dev.txt

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip wheel setuptools
          pip install pyinstaller
          pip install "matplotlib>=3.10.8"
          pip install -e . --no-cache-dir

      - name: Create Asari environment
        run: |
          cd pyinstaller
          python create_asari_env.py

      - name: Generate matplotlib font cache
        run: |
          cd pyinstaller
          python prebuild_matplotlib_cache.py

      - name: Build executable with PyInstaller
        run: |
          cd pyinstaller
          pyinstaller --noconfirm --clean --log-level=INFO Mint.spec
        env:
          PYTHONOPTIMIZE: 1

      - name: Verify build and check size
        run: |
          if [ -f "pyinstaller/dist/Mint/Mint" ]; then
            echo "‚úì Executable built successfully!"
            chmod +x pyinstaller/dist/Mint/Mint
            
            size=$(du -sh pyinstaller/dist/Mint | cut -f1)
            echo "Build size: $size"
          else
            echo "‚úó Build failed"
            exit 1
          fi

      - name: Create archive
        run: |
          cd pyinstaller/dist
          tar -czf Mint-Linux-x64.tar.gz Mint/
          
          zipSize=$(du -h Mint-Linux-x64.tar.gz | cut -f1)
          echo "Archive size: $zipSize"

      - name: Get version
        id: get_version
        run: |
          if [[ "$GITHUB_REF" == refs/tags/* ]]; then
            version=${GITHUB_REF#refs/tags/}
            if [[ "$version" =~ (alpha|beta|rc|preview) ]]; then
              is_prerelease=true
            else
              is_prerelease=false
            fi
          else
            version="dev-$(git rev-parse --short HEAD)"
            is_prerelease=true
          fi
          echo "version=$version" >> $GITHUB_OUTPUT
          echo "is_prerelease=$is_prerelease" >> $GITHUB_OUTPUT

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: Mint-Linux-x64-${{ steps.get_version.outputs.version }}
          path: pyinstaller/dist/Mint-Linux-x64.tar.gz
          retention-days: 90
          compression-level: 0

  build-macos:
    name: Build macOS Executable
    runs-on: macos-latest
    timeout-minutes: 180
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Free up disk space
        run: |
          sudo rm -rf /Applications/Xcode_*.app
          sudo rm -rf ~/Library/Android
          df -h
        continue-on-error: true

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
          cache: 'pip'
          cache-dependency-path: |
            pyproject.toml
            requirements-dev.txt

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip wheel setuptools
          pip install pyinstaller
          pip install "matplotlib>=3.10.8"
          pip install -e . --no-cache-dir

      - name: Create Asari environment
        run: |
          cd pyinstaller
          python create_asari_env.py

      - name: Generate matplotlib font cache
        run: |
          cd pyinstaller
          python prebuild_matplotlib_cache.py

      - name: Build executable with PyInstaller
        run: |
          cd pyinstaller
          pyinstaller --noconfirm --clean --log-level=INFO Mint.spec
        env:
          PYTHONOPTIMIZE: 1

      - name: Verify build and check size
        run: |
          if [ -f "pyinstaller/dist/Mint/Mint" ]; then
            echo "‚úì Executable built successfully!"
            chmod +x pyinstaller/dist/Mint/Mint
            
            size=$(du -sh pyinstaller/dist/Mint | cut -f1)
            echo "Build size: $size"
          else
            echo "‚úó Build failed"
            exit 1
          fi

      - name: Create archive
        run: |
          cd pyinstaller/dist
          tar -czf Mint-macOS-x64.tar.gz Mint/
          
          zipSize=$(du -h Mint-macOS-x64.tar.gz | cut -f1)
          echo "Archive size: $zipSize"

      - name: Get version
        id: get_version
        run: |
          if [[ "$GITHUB_REF" == refs/tags/* ]]; then
            version=${GITHUB_REF#refs/tags/}
            if [[ "$version" =~ (alpha|beta|rc|preview) ]]; then
              is_prerelease=true
            else
              is_prerelease=false
            fi
          else
            version="dev-$(git rev-parse --short HEAD)"
            is_prerelease=true
          fi
          echo "version=$version" >> $GITHUB_OUTPUT
          echo "is_prerelease=$is_prerelease" >> $GITHUB_OUTPUT

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: Mint-macOS-x64-${{ steps.get_version.outputs.version }}
          path: pyinstaller/dist/Mint-macOS-x64.tar.gz
          retention-days: 90
          compression-level: 0

  release:
    name: Create Release
    needs: [build-windows, build-linux, build-macos]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')
    
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts
          merge-multiple: true

      - name: List downloaded files
        run: |
          echo "Downloaded artifacts:"
          ls -lh artifacts/

      - name: Get version info
        id: version_info
        run: |
          version=${GITHUB_REF#refs/tags/}
          if [[ "$version" =~ (alpha|beta|rc|preview) ]]; then
            is_prerelease=true
          else
            is_prerelease=false
          fi
          echo "version=$version" >> $GITHUB_OUTPUT
          echo "is_prerelease=$is_prerelease" >> $GITHUB_OUTPUT

      - name: Create Pre-release
        if: steps.version_info.outputs.is_prerelease == 'true'
        uses: softprops/action-gh-release@v1
        with:
          files: artifacts/*
          draft: false
          prerelease: true
          generate_release_notes: true
          body: |
            ## ‚ö†Ô∏è Pre-release / Beta Version
            
            This is a **pre-release version** for public testing and feedback.
            **Not recommended for production use.**
            
            ### Downloads (~600 MB each)
            - **Windows**: `Mint-Windows-x64.zip`
            - **Linux**: `Mint-Linux-x64.tar.gz`
            - **macOS**: `Mint-macOS-x64.tar.gz`
            
            ### Installation
            1. Download the appropriate file for your platform
            2. Extract the archive
            3. Run the `Mint` executable
            
            ### Reporting Issues
            Please report bugs at: https://github.com/${{ github.repository }}/issues
            
            ---
            **Note**: Due to the large package size (~600 MB), download may take several minutes.
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Create Stable Release
        if: steps.version_info.outputs.is_prerelease == 'false'
        uses: softprops/action-gh-release@v1
        with:
          files: artifacts/*
          draft: false
          prerelease: false
          generate_release_notes: true
          body: |
            ## üéâ Stable Release
            
            ### Downloads (~600 MB each)
            - **Windows**: `Mint-Windows-x64.zip`
            - **Linux**: `Mint-Linux-x64.tar.gz`
            - **macOS**: `Mint-macOS-x64.tar.gz`
            
            ### Installation
            1. Download the appropriate file for your platform
            2. Extract the archive
            3. Run the `Mint` executable
            
            ### Documentation
            - [Full Documentation](https://LewisResearchGroup.github.io/ms-mint-app2/)
            - [Quick Start Guide](https://LewisResearchGroup.github.io/ms-mint-app2/quickstart/)
            
            ---
            **Note**: Due to the large package size (~600 MB), download may take several minutes.
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
