name: Build Executables (Optimized)

on:
  push:
    tags:
      - 'v*'  # Only build on version tags to save resources
  workflow_dispatch:  # Allow manual triggering

jobs:
  build-windows:
    name: Build Windows Executable
    runs-on: windows-latest
    timeout-minutes: 180
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Free up disk space
        run: |
          # Remove unnecessary software to free up space
          Remove-Item -Recurse -Force "C:\hostedtoolcache\windows\Python\3.7" -ErrorAction SilentlyContinue
          Remove-Item -Recurse -Force "C:\hostedtoolcache\windows\Python\3.8" -ErrorAction SilentlyContinue
          Remove-Item -Recurse -Force "C:\hostedtoolcache\windows\Python\3.9" -ErrorAction SilentlyContinue
          Remove-Item -Recurse -Force "C:\hostedtoolcache\windows\Python\3.10" -ErrorAction SilentlyContinue
          Remove-Item -Recurse -Force "C:\hostedtoolcache\windows\Python\3.11" -ErrorAction SilentlyContinue
        shell: powershell
        continue-on-error: true

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
          cache: 'pip'
          cache-dependency-path: |
            pyproject.toml
            requirements-dev.txt

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip wheel setuptools
          pip install pyinstaller
          pip install "matplotlib>=3.10.8"
          pip install -e . --no-cache-dir
        shell: bash

      - name: Create Asari environment
        run: |
          cd pyinstaller
          python create_asari_env.py
        shell: bash
        env:
          PYTHONIOENCODING: utf-8

      - name: Generate matplotlib font cache
        run: |
          cd pyinstaller
          python prebuild_matplotlib_cache.py
        shell: bash
        env:
          PYTHONIOENCODING: utf-8

      - name: Build executable with PyInstaller
        run: |
          cd pyinstaller
          pyinstaller --noconfirm --clean --log-level=INFO Mint.spec
        shell: bash
        env:
          PYTHONOPTIMIZE: 1

      - name: Verify build and check size
        run: |
          if (Test-Path "pyinstaller\dist\Mint\Mint.exe") {
            Write-Host "[OK] Executable built successfully!"
            
            $size = (Get-ChildItem -Path "pyinstaller\dist\Mint" -Recurse | Measure-Object -Property Length -Sum).Sum
            Write-Host "Build size: $([math]::Round($size/1GB, 2)) GB"
          } else {
            Write-Host "[ERROR] Build failed"
            exit 1
          }
        shell: powershell

      - name: Create archive with maximum compression
        run: |
          cd pyinstaller/dist
          Compress-Archive -Path Mint -DestinationPath Mint-Windows-x64.zip -CompressionLevel Optimal
          
          $zipSize = (Get-Item Mint-Windows-x64.zip).Length
          Write-Host "Archive size: $([math]::Round($zipSize/1MB, 2)) MB"
        shell: powershell

      - name: Get version
        id: get_version
        run: |
          if [[ "$GITHUB_REF" == refs/tags/* ]]; then
            version=${GITHUB_REF#refs/tags/}
            if [[ "$version" =~ (alpha|beta|rc|preview) ]]; then
              is_prerelease=true
            else
              is_prerelease=false
            fi
          else
            version="dev-$(git rev-parse --short HEAD)"
            is_prerelease=true
          fi
          echo "version=$version" >> $GITHUB_OUTPUT
          echo "is_prerelease=$is_prerelease" >> $GITHUB_OUTPUT
        shell: bash

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: Mint-Windows-x64-${{ steps.get_version.outputs.version }}
          path: pyinstaller/dist/Mint-Windows-x64.zip
          retention-days: 90
          compression-level: 0  # Already compressed

  build-linux:
    name: Build Linux Executable (Ubuntu 20.04)
    runs-on: ubuntu-20.04
    timeout-minutes: 180
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Free up disk space
        run: |
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /usr/local/lib/android
          sudo rm -rf /opt/ghc
          sudo rm -rf /opt/hostedtoolcache/CodeQL
          sudo docker image prune --all --force
          df -h
        continue-on-error: true

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
          cache: 'pip'
          cache-dependency-path: |
            pyproject.toml
            requirements-dev.txt

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip wheel setuptools
          pip install pyinstaller
          pip install "matplotlib>=3.10.8"
          pip install -e . --no-cache-dir

      - name: Create Asari environment
        run: |
          cd pyinstaller
          python create_asari_env.py
        continue-on-error: true
        env:
          PYTHONIOENCODING: utf-8

      - name: Generate matplotlib font cache
        run: |
          cd pyinstaller
          python prebuild_matplotlib_cache.py
        continue-on-error: true
        env:
          PYTHONIOENCODING: utf-8

      - name: Check disk space before build
        run: df -h

      - name: Build executable with PyInstaller
        run: |
          cd pyinstaller
          pyinstaller --noconfirm --clean --log-level=DEBUG Mint.spec 2>&1 | tee build.log
        env:
          PYTHONOPTIMIZE: 1

      - name: Show build log on failure
        if: failure()
        run: |
          echo "=== PyInstaller Build Log ==="
          cat pyinstaller/build.log || echo "No build log found"
          echo ""
          echo "=== Checking build directory ==="
          ls -la pyinstaller/build/ || echo "No build directory"
          echo ""
          echo "=== Checking dist directory ==="
          ls -la pyinstaller/dist/ || echo "No dist directory"

      - name: Verify build and check size
        run: |
          if [ -f "pyinstaller/dist/Mint/Mint" ]; then
            echo "[OK] Executable built successfully!"
            chmod +x pyinstaller/dist/Mint/Mint
            
            size=$(du -sh pyinstaller/dist/Mint | cut -f1)
            echo "Build size: $size"
          else
            echo "[ERROR] Build failed - executable not found"
            echo "Contents of dist directory:"
            ls -la pyinstaller/dist/ || echo "dist directory does not exist"
            exit 1
          fi

      - name: Get version
        id: get_version
        run: |
          if [[ "$GITHUB_REF" == refs/tags/* ]]; then
            version=${GITHUB_REF#refs/tags/}
            if [[ "$version" =~ (alpha|beta|rc|preview) ]]; then
              is_prerelease=true
            else
              is_prerelease=false
            fi
          else
            version="dev-$(git rev-parse --short HEAD)"
            is_prerelease=true
          fi
          echo "version=$version" >> $GITHUB_OUTPUT
          echo "is_prerelease=$is_prerelease" >> $GITHUB_OUTPUT

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: Mint-Linux-x64-${{ steps.get_version.outputs.version }}
          path: pyinstaller/dist/Mint/
          retention-days: 90
          compression-level: 6

  build-macos:
    name: Build macOS Executable
    runs-on: macos-latest
    timeout-minutes: 180
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Free up disk space
        run: |
          sudo rm -rf /Applications/Xcode_*.app
          sudo rm -rf ~/Library/Android
          df -h
        continue-on-error: true

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
          cache: 'pip'
          cache-dependency-path: |
            pyproject.toml
            requirements-dev.txt

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip wheel setuptools
          pip install pyinstaller
          pip install "matplotlib>=3.10.8"
          pip install -e . --no-cache-dir

      - name: Create Asari environment
        run: |
          cd pyinstaller
          python create_asari_env.py
        continue-on-error: true
        env:
          PYTHONIOENCODING: utf-8

      - name: Generate matplotlib font cache
        run: |
          cd pyinstaller
          python prebuild_matplotlib_cache.py
        continue-on-error: true
        env:
          PYTHONIOENCODING: utf-8

      - name: Build executable with PyInstaller
        run: |
          cd pyinstaller
          pyinstaller --noconfirm --clean --log-level=INFO Mint.spec
        env:
          PYTHONOPTIMIZE: 1

      - name: Verify build and check size
        run: |
          if [ -f "pyinstaller/dist/Mint/Mint" ]; then
            echo "[OK] Executable built successfully!"
            chmod +x pyinstaller/dist/Mint/Mint
            
            size=$(du -sh pyinstaller/dist/Mint | cut -f1)
            echo "Build size: $size"
          else
            echo "[ERROR] Build failed"
            exit 1
          fi

      - name: Get version
        id: get_version
        run: |
          if [[ "$GITHUB_REF" == refs/tags/* ]]; then
            version=${GITHUB_REF#refs/tags/}
            if [[ "$version" =~ (alpha|beta|rc|preview) ]]; then
              is_prerelease=true
            else
              is_prerelease=false
            fi
          else
            version="dev-$(git rev-parse --short HEAD)"
            is_prerelease=true
          fi
          echo "version=$version" >> $GITHUB_OUTPUT
          echo "is_prerelease=$is_prerelease" >> $GITHUB_OUTPUT

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: Mint-macOS-x64-${{ steps.get_version.outputs.version }}
          path: pyinstaller/dist/Mint/
          retention-days: 90
          compression-level: 6

  release:
    name: Create Release
    needs: [build-windows, build-linux, build-macos]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')
    
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: List downloaded files
        run: |
          echo "Downloaded artifacts:"
          ls -lhR artifacts/

      - name: Create release archives
        run: |
          set -e
          
          # Windows - already a zip, just rename/move it
          WINDOWS_ZIP=$(find artifacts -name "Mint-Windows-x64.zip" -type f | head -n 1)
          if [ -z "$WINDOWS_ZIP" ]; then
            echo "ERROR: Windows zip file not found"
            exit 1
          fi
          mv "$WINDOWS_ZIP" ./Mint-Windows-x64.zip
          echo "‚úì Windows archive ready: Mint-Windows-x64.zip"
          
          # Linux - create tar.gz from directory
          cd artifacts
          LINUX_DIR=$(find . -type d -name "Mint-Linux-x64-*" | head -n 1)
          if [ -z "$LINUX_DIR" ]; then
            echo "ERROR: Linux artifact directory not found"
            exit 1
          fi
          if [ ! -d "$LINUX_DIR/Mint" ]; then
            echo "ERROR: Mint/ subdirectory not found in Linux artifact"
            exit 1
          fi
          tar -czf ../Mint-Linux-x64.tar.gz -C "$LINUX_DIR" Mint/
          echo "‚úì Linux archive created: Mint-Linux-x64.tar.gz"
          
          # macOS - create tar.gz from directory
          MACOS_DIR=$(find . -type d -name "Mint-macOS-x64-*" | head -n 1)
          if [ -z "$MACOS_DIR" ]; then
            echo "ERROR: macOS artifact directory not found"
            exit 1
          fi
          if [ ! -d "$MACOS_DIR/Mint" ]; then
            echo "ERROR: Mint/ subdirectory not found in macOS artifact"
            exit 1
          fi
          tar -czf ../Mint-macOS-x64.tar.gz -C "$MACOS_DIR" Mint/
          echo "‚úì macOS archive created: Mint-macOS-x64.tar.gz"
          
          cd ..
          echo ""
          echo "=== Final Release Archives ==="
          ls -lh *.zip *.tar.gz

      - name: Get version info
        id: version_info
        run: |
          version=${GITHUB_REF#refs/tags/}
          if [[ "$version" =~ (alpha|beta|rc|preview) ]]; then
            is_prerelease=true
          else
            is_prerelease=false
          fi
          echo "version=$version" >> $GITHUB_OUTPUT
          echo "is_prerelease=$is_prerelease" >> $GITHUB_OUTPUT

      - name: Create Pre-release
        if: steps.version_info.outputs.is_prerelease == 'true'
        uses: softprops/action-gh-release@v1
        with:
          files: |
            Mint-Windows-x64.zip
            Mint-Linux-x64.tar.gz
            Mint-macOS-x64.tar.gz
          draft: false
          prerelease: true
          generate_release_notes: true
          body: |
            ## ‚ö†Ô∏è Pre-release / Beta Version
            
            This is a **pre-release version** for public testing and feedback.
            **Not recommended for production use.**
            
            ### Downloads
            - **Windows**: `Mint-Windows-x64.zip` - Extract and run `Mint/Mint.exe`
            - **Linux**: `Mint-Linux-x64.tar.gz` - Extract and run `Mint/Mint` (Ubuntu 20.04+)
            - **macOS**: `Mint-macOS-x64.tar.gz` - Extract and run `Mint/Mint`
            
            ### Installation
            
            **Windows:**
            ```powershell
            # Extract Mint-Windows-x64.zip
            cd Mint
            .\Mint.exe
            ```
            
            **Linux:**
            ```bash
            tar -xzf Mint-Linux-x64.tar.gz
            cd Mint
            ./Mint
            ```
            
            **macOS:**
            ```bash
            tar -xzf Mint-macOS-x64.tar.gz
            cd Mint
            ./Mint
            ```
            
            ### System Requirements
            - **Linux**: Ubuntu 20.04+, Debian 11+, or equivalent (glibc 2.31+)
            - **Ubuntu 18.04 users**: Please install from source (see documentation)
            
            ### Reporting Issues
            Please report bugs at: https://github.com/${{ github.repository }}/issues
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Create Stable Release
        if: steps.version_info.outputs.is_prerelease == 'false'
        uses: softprops/action-gh-release@v1
        with:
          files: |
            Mint-Windows-x64.zip
            Mint-Linux-x64.tar.gz
            Mint-macOS-x64.tar.gz
          draft: false
          prerelease: false
          generate_release_notes: true
          body: |
            ## üéâ Stable Release
            
            ### Downloads
            - **Windows**: `Mint-Windows-x64.zip` - Extract and run `Mint/Mint.exe`
            - **Linux**: `Mint-Linux-x64.tar.gz` - Extract and run `Mint/Mint` (Ubuntu 20.04+)
            - **macOS**: `Mint-macOS-x64.tar.gz` - Extract and run `Mint/Mint`
            
            ### Installation
            
            **Windows:**
            ```powershell
            # Extract Mint-Windows-x64.zip
            cd Mint
            .\Mint.exe
            ```
            
            **Linux:**
            ```bash
            tar -xzf Mint-Linux-x64.tar.gz
            cd Mint
            ./Mint
            ```
            
            **macOS:**
            ```bash
            tar -xzf Mint-macOS-x64.tar.gz
            cd Mint
            ./Mint
            ```
            
            ### System Requirements
            - **Linux**: Ubuntu 20.04+, Debian 11+, or equivalent (glibc 2.31+)
            - **Ubuntu 18.04 users**: Please install from source (see documentation)
            
            ### Documentation
            - [Full Documentation](https://LewisResearchGroup.github.io/ms-mint-app2/)
            - [Quick Start Guide](https://LewisResearchGroup.github.io/ms-mint-app2/quickstart/)
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
